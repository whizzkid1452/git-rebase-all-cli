#!/bin/bash

# gt ëª…ë ¹ì–´ ì°¾ê¸° (ì‹œìŠ¤í…œ ë˜ëŠ” npm ì„¤ì¹˜ëœ ë²„ì „)
find_gt() {
  # ë¨¼ì € ì‹œìŠ¤í…œ PATHì—ì„œ ì°¾ê¸°
  if command -v gt >/dev/null 2>&1; then
    echo "gt"
    return
  fi
  
  # npmìœ¼ë¡œ ì„¤ì¹˜ëœ ê²½ìš° node_modules/.bin/gt ì°¾ê¸°
  local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  local npm_gt="$script_dir/../node_modules/.bin/gt"
  if [ -f "$npm_gt" ]; then
    echo "$npm_gt"
    return
  fi
  
  # í˜„ì¬ ë””ë ‰í† ë¦¬ ê¸°ì¤€ìœ¼ë¡œë„ ì°¾ê¸°
  local current_gt="$(pwd)/node_modules/.bin/gt"
  if [ -f "$current_gt" ]; then
    echo "$current_gt"
    return
  fi
  
  # ì°¾ì§€ ëª»í•¨
  echo ""
}

GT_CMD=$(find_gt)
if [ -z "$GT_CMD" ]; then
  echo "âŒ 'gt' ëª…ë ¹ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  echo "   Graphite CLIë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”: npm install -g @withgraphite/graphite-cli"
  exit 1
fi

# Git repository root ì°¾ê¸° ë° ì´ë™
git_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "âŒ Git repositoryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Git repository ë‚´ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
  exit 1
}

cd "$git_root" || {
  echo "âŒ Git repository ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  exit 1
}

echo "$git_root"

# ëª¨ë“  ë¸Œëœì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (íŠ¸ë¦¬ ë¬¸ìì—´ê³¼ ì‹¬ë³¼ë¦­ ì œê±°)
all_branches=$($GT_CMD log short | sed 's/^develop$//' | grep -v '^$' | grep -v '^develop$' | sed 's/\(needs restack\)//')

if [ -z "$all_branches" ]; then
  echo "âŒ ì¶”ì  ì¤‘ì¸ ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

echo ""
echo "==== STEP 1: Moveí•  ë¸Œëœì¹˜ ì„ íƒ ===="
echo ""
echo "[STEP 1/2] Moveí•  ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:"
echo " "ìŠ¤í˜ì´ìŠ¤ë°”:ì„ íƒ/í•´ì œ, i:ì´ë™, Enter:í™•ì¸, Ctrl+C:ì·¨ì†Œ"
echo ""

move_branches=$(echo "$all_branches" | fzf \
  --multi \
  --no-sort \
  --reverse \
  --marker="âœ”" \
  --pointer="â¯" \
  --prompt=" Moveí•  ë¸Œëœì¹˜ ì„ íƒ â¯ " \
  --header="ìŠ¤í˜ì´ìŠ¤ë°”:ì„ íƒ/í•´ì œ | Enter: í™•ì¸ | Ctrl+A: ì „ì²´ì„ íƒ | Ctrl+D: ì „ì²´í•´ì œ | ESC: ìŠ¤í‚µ" \
  --preview='echo " ë¸Œëœì¹˜: {}"' \
  --preview-window=up:1 \
  --color='marker:green,pointer:blue;bg+:blue' \
  --bind='space:toggle,ctrl-a:select-all,ctrl-d:deselect-all')

# Move ì²˜ë¦¬
if [ -n "$move_branches" ]; then
  echo ""
  echo "Moveí•  ë¸Œëœì¹˜ë“¤:"
  echo "----------------------------------------"
  echo "$move_branches"
  echo "----------------------------------------"
  echo ""

  read -p "ìœ„ ë¸Œëœì¹˜ë“¤ì„ moveí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " confirm_move

  case $confirm_move in
    [yY]|[yY][eE][sS])
      echo ""
      echo "Move ì‹œì‘..."

      while IFS= read -r branch; do
        if [ -n "$branch" ]; then
          branch=$(echo "$branch" | sed -E 's/^[*+]?[[:space:]]*//' | sed -E 's/([[:space:]])*$//' | sed 's/(needs restack)//')
          if [ -n "$branch" ]; then
            echo "ğŸ’¬ Moving $branch..."
            git checkout "$branch" && $GT_CMD move < /dev/tty
            if [ $? -eq 0 ]; then
              echo "âœ… $branch move ì™„ë£Œ"
            else
              echo "âŒ $branch move ì‹¤íŒ¨"
            fi
          fi
        fi
      done <<< "$move_branches"

      echo ""
      echo "Move ì™„ë£Œ!"
      ;;
    *)
      echo ""
      echo "Move ì·¨ì†Œë¨."
      ;;
  esac
else
  echo ""
  echo "Moveí•  ë¸Œëœì¹˜ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
fi

# ë¸Œëœì¹˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (Move í›„ ìƒíƒœ ë°˜ì˜)
all_branches=$($GT_CMD log short | sed 's/^develop$//' | grep -v '^$' | grep -v '^develop$' | sed 's/\(needs restack\)//')

if [ -z "$all_branches" ]; then
  echo "âŒ ë” ì´ìƒ ì¶”ì  ì¤‘ì¸ ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤."
  exit 0
fi

echo ""
echo "==== STEP 2: Untrack ë¸Œëœì¹˜ ì„ íƒ ===="
echo ""
echo "[STEP 2/2] Untrackí•  ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:"
echo " "ìŠ¤í˜ì´ìŠ¤ë°”:ì„ íƒ/í•´ì œ, i:ì´ë™, Enter:í™•ì¸, Ctrl+C:ì·¨ì†Œ"
echo ""

untrack_branches=$(echo "$all_branches" | fzf \
  --multi \
  --no-sort \
  --reverse \
  --marker="âœ”" \
  --pointer="â¯" \
  --prompt=" Untrackí•  ë¸Œëœì¹˜ ì„ íƒ â¯ " \
  --header="ìŠ¤í˜ì´ìŠ¤ë°”:ì„ íƒ/í•´ì œ | Enter: í™•ì¸ | Ctrl+A: ì „ì²´ì„ íƒ | Ctrl+D: ì „ì²´í•´ì œ | ESC: ìŠ¤í‚µ" \
  --preview='echo " ë¸Œëœì¹˜: {}"' \
  --preview-window=up:1 \
  --color='marker:red,pointer:blue;bg+:blue' \
  --bind='space:toggle,ctrl-a:select-all,ctrl-d:deselect-all')

# Untrack ì²˜ë¦¬
if [ -n "$untrack_branches" ]; then
  echo ""
  echo "Untrackí•  ë¸Œëœì¹˜ë“¤:"
  echo "----------------------------------------"
  echo "$untrack_branches"
  echo "----------------------------------------"
  echo ""

  read -p "ìœ„ ë¸Œëœì¹˜ë“¤ì„ untrackí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " confirm_untrack

  case $confirm_untrack in
    [yY]|[yY][eE][sS])
      echo ""
      echo "Untrack ì‹œì‘..."

      while IFS= read -r branch; do
        if [ -n "$branch" ]; then
          branch=$(echo "$branch" | sed -E 's/^[*+]?[[:space:]]*//' | sed -E 's/([[:space:]])*$//' | sed 's/(needs restack)//')
          if [ -n "$branch" ]; then
            echo "ğŸ’¬ Untracking $branch..."
            if $GT_CMD untrack "$branch"; then
              echo "âœ… $branch untrack ì™„ë£Œ"
            else
              echo "âŒ $branch untrack ì‹¤íŒ¨"
            fi
          fi
        fi
      done <<< "$untrack_branches"

      echo ""
      echo "Untrack ì™„ë£Œ!"
      ;;
    *)
      echo ""
      echo "Untrack ì·¨ì†Œë¨."
      ;;
  esac
else
  echo ""
  echo "Untrackí•  ë¸Œëœì¹˜ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
fi

# End of gt-sync