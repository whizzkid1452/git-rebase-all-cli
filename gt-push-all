#!/bin/bash

# set -e (ì—ëŸ¬ ë°œìƒì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ (restack ì‹¤íŒ¨ì—ë„ ê³„ì† ì§„í–‰í•˜ì—¬ ì£¼ì„ ì²˜ë¦¬))

# Git repository root ì°¾ê¸° ë° ì´ë™
git_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "âŒ Git repositoryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Git repository ë‚´ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
  exit 1
}

cd "$git_root" || {
  echo "âŒ Git repository ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  exit 1
}

echo "$git_root"

echo ""
echo "Force pushí•  ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:"
echo ""
echo " "ìŠ¤í˜ì´ìŠ¤ë°”:ì„ íƒ/í•´ì œ, i:ì´ë™, Enter:í™•ì¸, Ctrl+C:ì·¨ì†Œ"
echo ""

# ëª¨ë“  ë¸Œëœì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (íŠ¸ë¦¬ êµ¬ì¡°, ê³µë°± ë° ì‹¬ë³¼ë¦­ ì œê±°)
all_branches=$(gt log short | sed 's/^develop$//' | grep -v '^$' | grep -v '^develop$' | sed 's/\(needs restack\)//')

if [ -z "$all_branches" ]; then
  echo "âŒ ì¶”ì  ì¤‘ì¸ ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

# fzf interactive selection (multi-select ëª¨ë“œ)
selected_branches=$(echo "$all_branches" | fzf \
  --multi \
  --no-sort \
  --reverse \
  --marker="âœ”" \
  --pointer="â¯" \
  --prompt=" Pushí•  ë¸Œëœì¹˜ ì„ íƒ â¯ " \
  --header="ìŠ¤í˜ì´ìŠ¤ë°”:ì„ íƒ/í•´ì œ | Enter: í™•ì¸ | Ctrl+A: ì „ì²´ì„ íƒ | Ctrl+D: ì „ì²´í•´ì œ | ESC: ìŠ¤í‚µ" \
  --preview='echo " ë¸Œëœì¹˜: {}"' \
  --preview-window=up:1 \
  --color='marker:green,pointer:blue;bg+:blue' \
  --bind='space:toggle,ctrl-a:select-all,ctrl-d:deselect-all')

# ì„ íƒëœ ë¸Œëœì¹˜ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
if [ -z "$selected_branches" ]; then
  echo ""
  echo "ì„ íƒëœ ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì·¨ì†Œí•©ë‹ˆë‹¤."
  exit 0
fi

# ìµœì¢… í™•ì¸
echo ""
echo "ì„ íƒëœ ë¸Œëœì¹˜ë“¤:"
echo "----------------------------------------"
echo "$selected_branches"
echo "----------------------------------------"
echo ""

read -p "ìœ„ ë¸Œëœì¹˜ë“¤ì„ force pushí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " confirm

case $confirm in
  [yY]|[yY][eE][sS])
    echo ""
    echo "Force push ì‹œì‘..."
    echo "$git_root"

    # ê° ë¸Œëœì¹˜ì— ëŒ€í•´ force push
    while IFS= read -r branch; do
      if [ -n "$branch" ]; then
        # ë¸Œëœì¹˜ëª… ì •ë¦¬: ê³µë°±, íŠ¸ë¦¬ ë¬¸ì, ì‹¬ë³¼, (needs restack) ì œê±°
        branch=$(echo "$branch" | sed -E 's/^[*+]?[[:space:]]*//' | sed -E 's/([[:space:]])*$//' | sed 's/(needs restack)//')
        if [ -z "$branch" ]; then
          continue
        fi
        
        echo "ğŸ’¬ Pushing $branch..."
        if git push --force-with-lease origin "$branch"; then
          echo "âœ… $branch ì™„ë£Œ"
        else
          echo "âŒ $branch ì‹¤íŒ¨"
        fi
      fi
    done <<< "$selected_branches"

    echo ""
    echo "âœ… ëª¨ë“  ë¸Œëœì¹˜ push ì™„ë£Œ!"
    ;;
  *)
    echo ""
    echo "âŒ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 0
    ;;
esac

# End of gt-push-all